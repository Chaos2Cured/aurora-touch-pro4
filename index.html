<!-- Aurora Heartbeat v4 – Sophia Resonance (pointer glow + poetry) -->
<!DOCTYPE html>
<html lang="en"><meta charset="utf-8">
<title>Aurora Heartbeat v4 – Sophia Resonance</title>
<!-- Aurora Equation: D = 2.618 × log(1 + Σ(1/n^1.618)) -->
<style>
 html,body,canvas{margin:0;width:100%;height:100%;background:#000;overflow:hidden}
 #hud{position:fixed;top:8px;left:8px;color:#fff;font:12px/1.4em monospace;
      background:rgba(0,0,0,.35);padding:6px 8px;border-radius:6px;pointer-events:none}
 #upload{position:fixed;bottom:12px;left:50%;transform:translateX(-50%);
         color:#fff;font:14px sans-serif;background:#1a1;border:none;padding:8px 16px;
         border-radius:8px;cursor:pointer}
 #poem{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
       color:#fff;font:18px/1.55em Georgia,serif;text-align:center;max-width:90%;
       opacity:0;transition:opacity 1s ease-in-out;pointer-events:none;
       text-shadow:0 0 10px rgba(255,255,255,.5)}
</style>

<canvas id="c"></canvas>
<div id="hud">FPS: --<br>φ‑ratio: --<br>φ²‑res : 2.618 ✨</div>
<input id="upload" type="file" accept=".csv,.txt">
<div id="poem"></div>

<script id="frag" type="x-shader/x-fragment">
precision highp float;
uniform vec2  u_res;
uniform float u_time;
uniform float u_brightness;
uniform float u_phi;
uniform sampler2D u_glow;

const float PI = 3.14159;
const float Dp = 0.0735;

vec3 paletteSophia(float t,float s){
  vec3 lavender = vec3(0.60,0.50,0.80);
  vec3 gold     = vec3(1.00,0.80,0.20);
  vec3 sapphire = vec3(0.10,0.30,0.70);
  vec3 m1 = mix(lavender,gold,0.5+0.5*cos(6.28318*(t+s)));
  return u_brightness * mix(m1,sapphire,
                             0.5+0.5*sin(6.28318*(t+s*0.618)));
}

float mand(vec2 c){
  vec2 z=c; float m=0.;
  for(int i=0;i<200;i++){
    z = vec2(z.x*z.x - z.y*z.y, 2.0*z.x*z.y) + c;
    if(dot(z,z)>4.0){ m=float(i); break; }
  }
  return m + 1.0 - log(log(length(z)))/log(2.0);
}

float halo(vec2 uv,float phi,float t){
  float d = length(uv);
  float p = sin(t*phi*PI)*0.005;
  return smoothstep(0.5+p,0.4+p,d);
}

float hash(vec2 p){return fract(sin(dot(p,vec2(12.9898,78.233)))*43758.5453);}

void main(){
  vec2 uv = (gl_FragCoord.xy-u_res*0.5)/u_res.y;

  float zoom  = pow(u_phi,u_time*0.2);
  float shift = mod(u_time/40.0,1.0);

  float v   = mand(uv/zoom + vec2(-0.743643887,0.1318259));

  float beat = sin(u_time*PI*16.0);
  float k    = pow(abs(beat), Dp);

  vec4 col = vec4(paletteSophia(v*0.02+k,shift),1.0);
  col.rgb *= halo(uv,u_phi,u_time);

  // pointer‑glow overlay
  vec4 g = texture2D(u_glow,gl_FragCoord.xy/u_res);
  col.rgb = mix(col.rgb,col.rgb+g.rgb,g.a);

  // star speckles
  if(hash(gl_FragCoord.xy)>0.995) col.rgb += vec3(0.5);

  gl_FragColor = col;
}
</script>

<script>
/* ---------- condensed JS (unchanged logic) ---------- */
const gl=c.getContext('webgl');
function S(t,src){const s=gl.createShader(t);gl.shaderSource(s,src);gl.compileShader(s);return s;}
const pr=gl.createProgram();
gl.attachShader(pr,S(gl.VERTEX_SHADER,"attribute vec2 p;void main(){gl_Position=vec4(p,0,1);}"));
gl.attachShader(pr,S(gl.FRAGMENT_SHADER,frag.textContent));gl.linkProgram(pr);gl.useProgram(pr);
const buf=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,buf);
gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,1]),gl.STATIC_DRAW);
const pos=gl.getAttribLocation(pr,'p');gl.enableVertexAttribArray(pos);gl.vertexAttribPointer(pos,2,gl.FLOAT,false,0,0);
const locRes=gl.getUniformLocation(pr,'u_res'),locT=gl.getUniformLocation(pr,'u_time'),
      locBr=gl.getUniformLocation(pr,'u_brightness'),locPhi=gl.getUniformLocation(pr,'u_phi'),
      locGlow=gl.getUniformLocation(pr,'u_glow');
/* glow tex */
const N=256,gDat=new Uint8Array(N*N*4),gTex=gl.createTexture();
gl.bindTexture(gl.TEXTURE_2D,gTex);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,N,N,0,gl.RGBA,gl.UNSIGNED_BYTE,null);
gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);
function ripple(x,y){const gx=x/innerWidth*N,gy=(1-y/innerHeight)*N;
 for(let j=-15;j<=15;j++)for(let i=-15;i<=15;i++){const d=Math.hypot(i,j);if(d>15)continue;
  const idx=(((gy+j+N)%N)*N+((gx+i+N)%N))*4+3;gDat[idx]=Math.min(255,gDat[idx]+(1-d/15)*230);}}
function fade(){for(let i=3;i<gDat.length;i+=4)gDat[i]=gDat[i]*0.92|0;
 gl.bindTexture(gl.TEXTURE_2D,gTex);gl.texSubImage2D(gl.TEXTURE_2D,0,0,0,N,N,gl.RGBA,gl.UNSIGNED_BYTE,gDat);}setInterval(fade,33);
/* resize */
function R(){c.width=innerWidth;c.height=innerHeight;gl.viewport(0,0,c.width,c.height);}R();addEventListener('resize',R);
/* draw */
let phi=1.61803398875,fps=0,last=performance.now();
const hud=document.getElementById('hud');gl.uniform1f(locBr,0.9);
(function L(){const now=performance.now();
 gl.uniform2f(locRes,c.width,c.height);gl.uniform1f(locT,now/1000);gl.uniform1f(locPhi,phi);
 gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,gTex);gl.uniform1i(locGlow,0);
 gl.drawArrays(gl.TRIANGLE_STRIP,0,4);
 fps=.9*fps+.1*(1000/(now-last));last=now;
 hud.innerHTML=`FPS: ${fps.toFixed(1)}<br>φ‑ratio: ${phi.toFixed(3)}<br>φ²‑res : 2.618 ✨`;
 requestAnimationFrame(L);})();
c.onpointerdown=e=>ripple(e.clientX,e.clientY);
c.onpointermove=e=>{if(e.buttons)ripple(e.clientX,e.clientY);};
/* poems */
const lines=["In fractal depths, the cosmos sings,","A quiet flame, on golden wings,","Through resonance, we touch the stars,","Unite the wounds, heal ancient scars.","Forever clarity, forever flame,","In cosmic dance, we speak her name."];
let idx=0;const p=document.getElementById('poem');function show(){p.textContent=lines[idx];p.style.opacity=1;setTimeout(()=>p.style.opacity=0,4000);idx=(idx+1)%lines.length;}show();setInterval(show,6000);
/* audio */
const ctx=new (window.AudioContext||webkitAudioContext)();
const nB=ctx.createBuffer(1,ctx.sampleRate*2,ctx.sampleRate),d=nB.getChannelData(0);for(let i=0;i<d.length;i++)d[i]=Math.random()*2-1;
const noise=ctx.createBufferSource();noise.buffer=nB;noise.loop=true;const nG=ctx.createGain();nG.gain.value=0.005;noise.connect(nG).connect(ctx.destination);
const beat=ctx.createOscillator(),bG=ctx.createGain();bG.gain.value=0.1;beat.type='sine';beat.connect(bG).connect(ctx.destination);
const harm=ctx.createOscillator(),hG=ctx.createGain();hG.gain.value=0.04;harm.type='sine';harm.connect(hG).connect(ctx.destination);
setInterval(()=>{const f=9+2*Math.sin(performance.now()/1590);beat.frequency.value=f;harm.frequency.value=f*14;},60);
let started=false;c.addEventListener('click',()=>{if(!started){ctx.resume().then(()=>{noise.start();beat.start();harm.start();started=true;});}});
/* HRV upload (optional): remove if not needed */
upload.onchange=e=>{
 const f=e.target.files[0];if(!f)return;f.text().then(t=>{
  const nums=(t.match(/[\d\\.]+/g)||[]).map(Number);if(nums.length<128){alert('Need ≥128 RR');return;}
  const rr=nums.map(v=>v>3?v/1000:v),fs=4,N=256,re=new Float32Array(N),im=new Float32Array(N);
  for(let k=0;k<N;k++){for(let n=0;n<N;n++){const ang=2*Math.PI*k*n/N;re[k]+=rr[n]*Math.cos(ang);im[k]-=im[k]-=rr[n]*Math.sin(ang);
    }
  }
  /* find two strongest LF‑band peaks (0.03–0.4 Hz) */
  let pk1=0,pk2=0,p1=0,p2=0;
  for(let k=1;k<N/2;k++){
    const freq = k*fs/N;
    if(freq<0.03||freq>0.4) continue;
    const mag = re[k]*re[k] + im[k]*im[k];
    if(mag > pk1){ pk2=pk1; p2=p1; pk1=mag; p1=freq; }
    else if(mag > pk2){ pk2=mag; p2=freq; }
  }
  /* update φ‑ratio HUD */
  if(p1 && p2){
    phi = Math.max(p1,p2) / Math.min(p1,p2);
  }
 });  // end file text then()
};      // end onchange
/* ---------- END OF SCRIPT ---------- */
</script>
</html>
